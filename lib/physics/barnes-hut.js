var BarnesHutTree=function(){var n=[],i=0,e=null,a=.5,d={init:function(n,s,t){a=t,i=0,(e=d._newBranch()).origin=n,e.size=s.subtract(n)},insert:function(n){for(var i=e,a=[n];a.length;){var s=a.shift(),t=s._m||s.m,o=d._whichQuad(s,i);if(void 0===i[o])i[o]=s,i.mass+=t,i.p?i.p=i.p.add(s.p.multiply(t)):i.p=s.p.multiply(t);else if("origin"in i[o])i.mass+=t,i.p?i.p=i.p.add(s.p.multiply(t)):i.p=s.p.multiply(t),i=i[o],a.unshift(s);else{var p=i.size.divide(2),r=new Point(i.origin);"s"==o[0]&&(r.y+=p.y),"e"==o[1]&&(r.x+=p.x);var u=i[o];if(i[o]=d._newBranch(),i[o].origin=r,i[o].size=p,i.mass=t,i.p=s.p.multiply(t),i=i[o],u.p.x===s.p.x&&u.p.y===s.p.y){var l=.08*p.x,m=.08*p.y;u.p.x=Math.min(r.x+p.x,Math.max(r.x,u.p.x-l/2+Math.random()*l)),u.p.y=Math.min(r.y+p.y,Math.max(r.y,u.p.y-m/2+Math.random()*m))}a.push(u),a.unshift(s)}}},applyForces:function(n,i){for(var d=[e];d.length;)if(node=d.shift(),void 0!==node&&n!==node)if("f"in node){var s=n.p.subtract(node.p),t=Math.max(1,s.magnitude()),o=(s.magnitude()>0?s:Point.random(1)).normalize();n.applyForce(o.multiply(i*(node._m||node.m)).divide(t*t))}else{var p=n.p.subtract(node.p.divide(node.mass)).magnitude();if(Math.sqrt(node.size.x*node.size.y)/p>a)d.push(node.ne),d.push(node.nw),d.push(node.se),d.push(node.sw);else{var s=n.p.subtract(node.p.divide(node.mass)),t=Math.max(1,s.magnitude()),o=(s.magnitude()>0?s:Point.random(1)).normalize();n.applyForce(o.multiply(i*node.mass).divide(t*t))}}},_whichQuad:function(n,i){if(n.p.exploded())return null;var e=n.p.subtract(i.origin),a=i.size.divide(2);return e.y<a.y?e.x<a.x?"nw":"ne":e.x<a.x?"sw":"se"},_newBranch:function(){if(n[i]){var e=n[i];e.ne=e.nw=e.se=e.sw=void 0,e.mass=0,delete e.p}else e={origin:null,size:null,nw:void 0,ne:void 0,sw:void 0,se:void 0,mass:0},n[i]=e;return i++,e}};return d};