var Physics=function(t,i,n,e,r,o){var a=BarnesHutTree(),p={particles:{},springs:{}},c={particles:{}},l=[],s=[],u=0,d={sum:0,max:0,mean:0},f={topleft:new Point(-1,-1),bottomright:new Point(1,1)},y={integrator:["verlet","euler"].indexOf(o)>=0?o:"verlet",stiffness:void 0!==i?i:1e3,repulsion:void 0!==n?n:600,friction:void 0!==e?e:.3,gravity:!1,dt:void 0!==t?t:.02,theta:.4,init:function(){return y},modifyPhysics:function(t){$.each(["stiffness","repulsion","friction","gravity","dt","precision","integrator"],function(i,n){if(void 0!==t[n]){if("precision"==n)return void(y.theta=1-t[n]);if(y[n]=t[n],"stiffness"==n){var e=t[n];$.each(p.springs,function(t,i){i.k=e})}}})},addNode:function(t){var i=t.id,n=t.m,e=f.bottomright.x-f.topleft.x,r=f.bottomright.y-f.topleft.y,o=new Point(null!=t.x?t.x:f.topleft.x+e*Math.random(),null!=t.y?t.y:f.topleft.y+r*Math.random());p.particles[i]=new Particle(o,n),p.particles[i].connections=0,p.particles[i].fixed=1===t.f,c.particles[i]=p.particles[i],l.push(p.particles[i])},dropNode:function(t){var i=t.id,n=p.particles[i],e=$.inArray(n,l);e>-1&&l.splice(e,1),delete p.particles[i],delete c.particles[i]},modifyNode:function(t,i){if(t in p.particles){var n=p.particles[t];"x"in i&&(n.p.x=i.x),"y"in i&&(n.p.y=i.y),"m"in i&&(n.m=i.m),"f"in i&&(n.fixed=1===i.f),"_m"in i&&(void 0===n._m&&(n._m=n.m),n.m=i._m)}},addSpring:function(t){var i=t.id,n=t.l,e=p.particles[t.fm],r=p.particles[t.to];void 0!==e&&void 0!==r&&(p.springs[i]=new Spring(e,r,n,y.stiffness),s.push(p.springs[i]),e.connections++,r.connections++,delete c.particles[t.fm],delete c.particles[t.to])},dropSpring:function(t){var i=t.id,n=p.springs[i];n.point1.connections--,n.point2.connections--;var e=$.inArray(n,s);e>-1&&s.splice(e,1),delete p.springs[i]},_update:function(t){return u++,$.each(t,function(t,i){i.t in y&&y[i.t](i)}),u},tick:function(){y.tendParticles(),"euler"==y.integrator?(y.updateForces(),y.updateVelocity(y.dt),y.updatePosition(y.dt)):(y.updateForces(),y.cacheForces(),y.updatePosition(y.dt),y.updateForces(),y.updateVelocity(y.dt)),y.tock()},tock:function(){var t=[];$.each(p.particles,function(i,n){t.push(i),t.push(n.p.x),t.push(n.p.y)}),r&&r({geometry:t,epoch:u,energy:d,bounds:f})},tendParticles:function(){$.each(p.particles,function(t,i){void 0!==i._m&&(Math.abs(i.m-i._m)<1?(i.m=i._m,delete i._m):i.m*=.98),i.v.x=i.v.y=0})},updateForces:function(){y.repulsion>0&&(y.theta>0?y.applyBarnesHutRepulsion():y.applyBruteForceRepulsion()),y.stiffness>0&&y.applySprings(),y.applyCenterDrift(),y.gravity&&y.applyCenterGravity()},cacheForces:function(){$.each(p.particles,function(t,i){i._F=i.f})},applyBruteForceRepulsion:function(){$.each(p.particles,function(t,i){$.each(p.particles,function(t,n){if(i!==n){var e=i.p.subtract(n.p),r=Math.max(1,e.magnitude()),o=(e.magnitude()>0?e:Point.random(1)).normalize();i.applyForce(o.multiply(y.repulsion*(n._m||n.m)*.5).divide(r*r*.5)),n.applyForce(o.multiply(y.repulsion*(i._m||i.m)*.5).divide(r*r*-.5))}})})},applyBarnesHutRepulsion:function(){if(f.topleft&&f.bottomright){var t=new Point(f.bottomright),i=new Point(f.topleft);a.init(i,t,y.theta),$.each(p.particles,function(t,i){a.insert(i)}),$.each(p.particles,function(t,i){a.applyForces(i,y.repulsion)})}},applySprings:function(){$.each(p.springs,function(t,i){var n=i.point2.p.subtract(i.point1.p),e=i.length-n.magnitude(),r=(n.magnitude()>0?n:Point.random(1)).normalize();i.point1.applyForce(r.multiply(i.k*e*-.5)),i.point2.applyForce(r.multiply(i.k*e*.5))})},applyCenterDrift:function(){var t=0,i=new Point(0,0);if($.each(p.particles,function(n,e){i.add(e.p),t++}),0!=t){var n=i.divide(-t);$.each(p.particles,function(t,i){i.applyForce(n)})}},applyCenterGravity:function(){$.each(p.particles,function(t,i){var n=i.p.multiply(-1);i.applyForce(n.multiply(y.repulsion/100))})},updateVelocity:function(t){var i=0,n=0,e=0;$.each(p.particles,function(r,o){if(o.fixed)return o.v=new Point(0,0),void(o.f=new Point(0,0));"euler"==y.integrator?o.v=o.v.add(o.f.multiply(t)).multiply(1-y.friction):o.v=o.v.add(o.f.add(o._F.divide(o._m)).multiply(.5*t)).multiply(1-y.friction),o.f.x=o.f.y=0;var a=o.v.magnitude();a>1e3&&(o.v=o.v.divide(a*a));var p=(a=o.v.magnitude())*a;i+=p,n=Math.max(p,n),e++}),d={sum:i,max:n,mean:i/e,n:e}},updatePosition:function(t){var i=null,n=null;$.each(p.particles,function(e,r){if("euler"==y.integrator)r.p=r.p.add(r.v.multiply(t));else{var o=r.f.multiply(.5*t*t).divide(r.m);r.p=r.p.add(r.v.multiply(t)).add(o)}if(!i)return i=new Point(r.p.x,r.p.y),void(n=new Point(r.p.x,r.p.y));var a=r.p;null!==a.x&&null!==a.y&&(a.x>i.x&&(i.x=a.x),a.y>i.y&&(i.y=a.y),a.x<n.x&&(n.x=a.x),a.y<n.y&&(n.y=a.y))}),f={topleft:n||new Point(-1,-1),bottomright:i||new Point(1,1)}},systemEnergy:function(t){return d}};return y.init()},_nearParticle=function(t,i){var i=i||0,n=t.x,e=t.y,r=2*i;return new Point(n-i+Math.random()*r,e-i+Math.random()*r)};