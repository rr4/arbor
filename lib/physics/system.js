var ParticleSystem=function(e,t,n,d,o,i,r,a){var s=[],c=null,u=0,f=null,p=.04,l=[20,20,20,20],_=null,g=null;if("object"==typeof e){var h=e;n=h.friction,e=h.repulsion,o=h.fps,i=h.dt,t=h.stiffness,d=h.gravity,r=h.precision,a=h.integrator}"verlet"!=a&&"euler"!=a&&(a="verlet"),n=isNaN(n)?.5:n,e=isNaN(e)?1e3:e,o=isNaN(o)?55:o;var y,v={integrator:a,repulsion:e,stiffness:t=isNaN(t)?600:t,friction:n,dt:i=isNaN(i)?.02:i,gravity:d=!0===d,precision:r=isNaN(r)?.6:r,timeout:void 0!==o?1e3/o:20},m={renderer:null,tween:null,nodes:{},edges:{},adjacency:{},names:{},kernel:null},N={parameters:function(e){return void 0!==e&&(isNaN(e.precision)||(e.precision=Math.max(0,Math.min(1,e.precision))),$.each(v,function(t,n){void 0!==e[t]&&(v[t]=e[t])}),m.kernel.physicsModified(e)),v},fps:function(e){if(void 0===e)return m.kernel.fps();N.parameters({timeout:1e3/(e||50)})},start:function(){m.kernel.start()},stop:function(){m.kernel.stop()},addNode:function(e,t){t=t||{};var n=m.names[e];if(n)return n.data=t,n;if(void 0!=e){var d=void 0!=t.x?t.x:null,o=void 0!=t.y?t.y:null,i=t.fixed?1:0,r=new Node(t);return r.name=e,m.names[e]=r,m.nodes[r._id]=r,s.push({t:"addNode",id:r._id,m:r.mass,x:d,y:o,f:i}),N._notify(),r}},pruneNode:function(e){var t=N.getNode(e);void 0!==m.nodes[t._id]&&(delete m.nodes[t._id],delete m.names[t.name]),$.each(m.edges,function(e,n){n.source._id!==t._id&&n.target._id!==t._id||N.pruneEdge(n)}),s.push({t:"dropNode",id:t._id}),N._notify()},getNode:function(e){return void 0!==e._id?e:"string"==typeof e||"number"==typeof e?m.names[e]:void 0},eachNode:function(e){$.each(m.nodes,function(t,n){if(null!=n._p.x&&null!=n._p.y){var d=null!==f?N.toScreen(n._p):n._p;e.call(N,n,d)}})},addEdge:function(e,t,n){e=N.getNode(e)||N.addNode(e),t=N.getNode(t)||N.addNode(t),n=n||{};var d=new Edge(e,t,n),o=e._id,i=t._id;if(m.adjacency[o]=m.adjacency[o]||{},m.adjacency[o][i]=m.adjacency[o][i]||[],!(m.adjacency[o][i].length>0)){m.edges[d._id]=d,m.adjacency[o][i].push(d);var r=void 0!==d.length?d.length:1;return s.push({t:"addSpring",id:d._id,fm:o,to:i,l:r}),N._notify(),d}$.extend(m.adjacency[o][i].data,d.data)},pruneEdge:function(e){s.push({t:"dropSpring",id:e._id}),delete m.edges[e._id];for(var t in m.adjacency)for(var n in m.adjacency[t])for(var d=m.adjacency[t][n].length-1;d>=0;d--)m.adjacency[t][n][d]._id===e._id&&m.adjacency[t][n].splice(d,1);N._notify()},getEdges:function(e,t){return e=N.getNode(e),t=N.getNode(t),e&&t&&void 0!==m.adjacency[e._id]&&void 0!==m.adjacency[e._id][t._id]?m.adjacency[e._id][t._id]:[]},getEdgesFrom:function(e){if(!(e=N.getNode(e)))return[];if(void 0!==m.adjacency[e._id]){var t=[];return $.each(m.adjacency[e._id],function(e,n){t=t.concat(n)}),t}return[]},getEdgesTo:function(e){if(!(e=N.getNode(e)))return[];var t=[];return $.each(m.edges,function(n,d){d.target==e&&t.push(d)}),t},eachEdge:function(e){$.each(m.edges,function(t,n){var d=m.nodes[n.source._id]._p,o=m.nodes[n.target._id]._p;null!=d.x&&null!=o.x&&(d=null!==f?N.toScreen(d):d,o=null!==f?N.toScreen(o):o,d&&o&&e.call(N,n,d,o))})},prune:function(e){var t={dropped:{nodes:[],edges:[]}};return void 0===e?$.each(m.nodes,function(e,n){t.dropped.nodes.push(n),N.pruneNode(n)}):N.eachNode(function(n){e.call(N,n,{from:N.getEdgesFrom(n),to:N.getEdgesTo(n)})&&(t.dropped.nodes.push(n),N.pruneNode(n))}),t},graft:function(e){var t={added:{nodes:[],edges:[]}};return e.nodes&&$.each(e.nodes,function(e,n){var d=N.getNode(e);d?d.data=n:t.added.nodes.push(N.addNode(e,n)),m.kernel.start()}),e.edges&&$.each(e.edges,function(e,n){N.getNode(e)||t.added.nodes.push(N.addNode(e,{})),$.each(n,function(n,d){N.getNode(n)||t.added.nodes.push(N.addNode(n,{}));var o=N.getEdges(e,n);o.length>0?o[0].data=d:t.added.edges.push(N.addEdge(e,n,d))})}),t},merge:function(e){var t={added:{nodes:[],edges:[]},dropped:{nodes:[],edges:[]}};$.each(m.edges,function(n,d){void 0!==e.edges[d.source.name]&&void 0!==e.edges[d.source.name][d.target.name]||(N.pruneEdge(d),t.dropped.edges.push(d))});var n=N.prune(function(n,d){if(void 0===e.nodes[n.name])return t.dropped.nodes.push(n),!0}),d=N.graft(e);return t.added.nodes=t.added.nodes.concat(d.added.nodes),t.added.edges=t.added.edges.concat(d.added.edges),t.dropped.nodes=t.dropped.nodes.concat(n.dropped.nodes),t.dropped.edges=t.dropped.edges.concat(n.dropped.edges),t},tweenNode:function(e,t,n){var d=N.getNode(e);d&&m.tween.to(d,t,n)},tweenEdge:function(e,t,n,d){if(void 0===d)N._tweenEdge(e,t,n);else{var o=N.getEdges(e,t);$.each(o,function(e,t){N._tweenEdge(t,n,d)})}},_tweenEdge:function(e,t,n){e&&void 0!==e._id&&m.tween.to(e,t,n)},_updateGeometry:function(e){if(void 0!=e){var t=e.epoch<u;y=e.energy;var n=e.geometry;if(void 0!==n)for(var d=0,o=n.length/3;d<o;d++){var i=n[3*d];t&&void 0==m.nodes[i]||(m.nodes[i]._p.x=n[3*d+1],m.nodes[i]._p.y=n[3*d+2])}}},screen:function(e){if(void 0==e)return{size:f?objcopy(f):void 0,padding:l.concat(),step:p};void 0!==e.size&&N.screenSize(e.size.width,e.size.height),isNaN(e.step)||N.screenStep(e.step),void 0!==e.padding&&N.screenPadding(e.padding)},screenSize:function(e,t){f={width:e,height:t},N._updateBounds()},screenPadding:function(e,t,n,d){$.isArray(e)?trbl=e:trbl=[e,t,n,d];var o=trbl[0],i=trbl[1],r=trbl[2];void 0===i?trbl=[o,o,o,o]:void 0==r&&(trbl=[o,i,o,i]),l=trbl},screenStep:function(e){p=e},toScreen:function(e){if(_&&f){var t=l||[0,0,0,0],n=_.bottomright.subtract(_.topleft),d=t[3]+e.subtract(_.topleft).divide(n.x).x*(f.width-(t[1]+t[3])),o=t[0]+e.subtract(_.topleft).divide(n.y).y*(f.height-(t[0]+t[2]));return arbor.Point(d,o)}},fromScreen:function(e){if(_&&f){var t=l||[0,0,0,0],n=_.bottomright.subtract(_.topleft),d=(e.x-t[3])/(f.width-(t[1]+t[3]))*n.x+_.topleft.x,o=(e.y-t[0])/(f.height-(t[0]+t[2]))*n.y+_.topleft.y;return arbor.Point(d,o)}},_updateBounds:function(e){if(null!==f){g=e||N.bounds();var t=new Point(g.bottomright.x,g.bottomright.y),n=new Point(g.topleft.x,g.topleft.y),d=t.subtract(n),o=n.add(d.divide(2)),i=new Point(Math.max(d.x,4),Math.max(d.y,4));if(g.topleft=o.subtract(i.divide(2)),g.bottomright=o.add(i.divide(2)),!_)return!$.isEmptyObject(m.nodes)&&(_=g,!0);var r=p;_newBounds={bottomright:_.bottomright.add(g.bottomright.subtract(_.bottomright).multiply(r)),topleft:_.topleft.add(g.topleft.subtract(_.topleft).multiply(r))};var a=new Point(_.topleft.subtract(_newBounds.topleft).magnitude(),_.bottomright.subtract(_newBounds.bottomright).magnitude());return(a.x*f.width>1||a.y*f.height>1)&&(_=_newBounds,!0)}},energy:function(){return y},bounds:function(){var e=null,t=null;return $.each(m.nodes,function(n,d){if(!e)return e=new Point(d._p),void(t=new Point(d._p));var o=d._p;null!==o.x&&null!==o.y&&(o.x>e.x&&(e.x=o.x),o.y>e.y&&(e.y=o.y),o.x<t.x&&(t.x=o.x),o.y<t.y&&(t.y=o.y))}),e&&t?{bottomright:e,topleft:t}:{topleft:new Point(-1,-1),bottomright:new Point(1,1)}},nearest:function(e){null!==f&&(e=N.fromScreen(e));var t={node:null,point:null,distance:null};return $.each(m.nodes,function(n,d){var o=d._p;if(null!==o.x&&null!==o.y){var i=o.subtract(e).magnitude();(null===t.distance||i<t.distance)&&(t={node:d,point:o,distance:i},null!==f&&(t.screenPoint=N.toScreen(o)))}}),t.node?(null!==f&&(t.distance=N.toScreen(t.node.p).subtract(N.toScreen(e)).magnitude()),t):null},_notify:function(){null===c?u++:clearTimeout(c),c=setTimeout(N._synchronize,20)},_synchronize:function(){s.length>0&&(m.kernel.graphChanged(s),s=[],c=null)}};return m.kernel=Kernel(N),m.tween=m.kernel.tween||null,Node.prototype.__defineGetter__("p",function(){var e=this,t={};return t.__defineGetter__("x",function(){return e._p.x}),t.__defineSetter__("x",function(t){m.kernel.particleModified(e._id,{x:t})}),t.__defineGetter__("y",function(){return e._p.y}),t.__defineSetter__("y",function(t){m.kernel.particleModified(e._id,{y:t})}),t.__proto__=Point.prototype,t}),Node.prototype.__defineSetter__("p",function(e){this._p.x=e.x,this._p.y=e.y,m.kernel.particleModified(this._id,{x:e.x,y:e.y})}),Node.prototype.__defineGetter__("mass",function(){return this._mass}),Node.prototype.__defineSetter__("mass",function(e){this._mass=e,m.kernel.particleModified(this._id,{m:e})}),Node.prototype.__defineSetter__("tempMass",function(e){m.kernel.particleModified(this._id,{_m:e})}),Node.prototype.__defineGetter__("fixed",function(){return this._fixed}),Node.prototype.__defineSetter__("fixed",function(e){this._fixed=e,m.kernel.particleModified(this._id,{f:e?1:0})}),N};